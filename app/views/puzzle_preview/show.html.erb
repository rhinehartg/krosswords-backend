<!DOCTYPE html>
<html>
<head>
  <title>Puzzle Preview: <%= @puzzle.title %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #333;
      padding-bottom: 20px;
    }
    
    .puzzle-title {
      font-size: 2.5em;
      color: #333;
      margin: 0;
    }
    
    .puzzle-description {
      font-size: 1.2em;
      color: #666;
      margin: 10px 0;
    }
    
    .puzzle-meta {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 15px 0;
    }
    
    .meta-item {
      background: #e9ecef;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
    }
    
    .difficulty-easy { background-color: #d4edda; color: #155724; }
    .difficulty-medium { background-color: #fff3cd; color: #856404; }
    .difficulty-hard { background-color: #f8d7da; color: #721c24; }
    
    .content {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }
    
    .crossword-grid {
      flex: 1;
      min-width: 400px;
    }
    
    .clues-panel {
      flex: 1;
      min-width: 300px;
    }
    
    .grid {
      display: inline-block;
      border: 2px solid #333;
      margin: 20px auto;
    }
    
    .grid-row {
      display: flex;
    }
    
    .grid-cell {
      width: 30px;
      height: 30px;
      border: 1px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      background: white;
    }
    
    .grid-cell.black {
      background: #333;
    }
    
    .grid-cell.numbered {
      position: relative;
    }
    
    .cell-number {
      position: absolute;
      top: 2px;
      left: 2px;
      font-size: 10px;
      font-weight: bold;
      color: #333;
    }
    
    .clues-section {
      margin-bottom: 30px;
    }
    
    .clues-title {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }
    
    .clue-item {
      margin-bottom: 10px;
      padding: 8px;
      background: #f8f9fa;
      border-left: 4px solid #007bff;
      border-radius: 4px;
    }
    
    .clue-number {
      font-weight: bold;
      color: #007bff;
    }
    
    .clue-text {
      margin-left: 10px;
    }
    
    .back-button {
      display: inline-block;
      background: #007bff;
      color: white;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .back-button:hover {
      background: #0056b3;
    }
    
    @media (max-width: 768px) {
      .content {
        flex-direction: column;
      }
      
      .grid-cell {
        width: 25px;
        height: 25px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="<%= admin_puzzle_path(@puzzle) %>" class="back-button">← Back to Puzzle</a>
    
    <div class="header">
      <h1 class="puzzle-title"><%= @puzzle.title %></h1>
      <p class="puzzle-description">
        <%= if @puzzle.game_type == 'krisskross' || @puzzle.game_type == 'konundrum'
              @puzzle.clue || @puzzle.puzzle_data&.dig('clue') || @puzzle.description
            else
              @puzzle.description
            end %>
      </p>
      <div class="puzzle-meta">
        <span class="meta-item difficulty-<%= @puzzle.difficulty.downcase %>">
          <%= @puzzle.difficulty %>
        </span>
        <span class="meta-item">
          <%= "⭐" * @puzzle.rating %> Rating
        </span>
        <span class="meta-item">
          <%= if @puzzle.game_type == 'krisskross' && @puzzle.puzzle_data.present?
                @puzzle.puzzle_data['words']&.count || @puzzle.puzzle_data[:words]&.count || @puzzle.clues.count
              else
                @puzzle.clues.count
              end %> Words
        </span>
      </div>
    </div>

    <div class="content">
      <div class="crossword-grid">
        <div class="grid">
          <% @crossword_layout[:table].each_with_index do |row, row_index| %>
            <div class="grid-row">
              <% row.each_with_index do |cell, col_index| %>
                <% 
                  is_black = cell.blank?
                  word_at_position = @crossword_layout[:result].find do |word|
                    # Skip words with missing coordinates
                    next if word[:startx].nil? || word[:starty].nil?
                    
                    # Convert 1-based coordinates to 0-based for comparison
                    word_start_row = word[:starty] - 1
                    word_start_col = word[:startx] - 1
                    
                    if word[:orientation] == 'across'
                      word_start_row == row_index && 
                      col_index >= word_start_col && 
                      col_index < word_start_col + word[:answer].length
                    else
                      word_start_col == col_index && 
                      row_index >= word_start_row && 
                      row_index < word_start_row + word[:answer].length
                    end
                  end
                  
                  is_numbered = word_at_position && 
                    word_at_position[:startx] && 
                    word_at_position[:starty] &&
                    (word_at_position[:startx] - 1) == col_index && 
                    (word_at_position[:starty] - 1) == row_index
                %>
                <div class="grid-cell <%= 'black' if is_black %> <%= 'numbered' if is_numbered %>">
                  <% if is_numbered %>
                    <span class="cell-number"><%= word_at_position[:position] %></span>
                  <% end %>
                  <%= cell unless is_black %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>

      <div class="clues-panel">
        <div class="clues-section">
          <h3 class="clues-title">Across</h3>
          <% @crossword_layout[:result].select { |w| w[:orientation] == 'across' }.each do |word| %>
            <div class="clue-item">
              <span class="clue-number"><%= word[:position] %>.</span>
              <span class="clue-text"><%= word[:clue] %></span>
            </div>
          <% end %>
        </div>

        <div class="clues-section">
          <h3 class="clues-title">Down</h3>
          <% @crossword_layout[:result].select { |w| w[:orientation] == 'down' }.each do |word| %>
            <div class="clue-item">
              <span class="clue-number"><%= word[:position] %>.</span>
              <span class="clue-text"><%= word[:clue] %></span>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
